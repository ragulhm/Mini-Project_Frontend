<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduPlanner OS Assessment</title>
    <!-- Assuming styles.css is in the same directory (client/) -->
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>

    <div id="container">
        <h1>EduPlanner Assessment: Student Post-Test</h1>
        <p>This UI simulates the student's post-test. The answers collected here determine the input data used by the LLM Agents for generating the customized lesson plan.</p>

        <div id="profile-card">
            <h2>Student: Alex | Topic: Process Synchronization</h2>
            <p><strong>Skill-Tree Context:</strong> Low proficiency in Concurrency & Sync (Level 2), requiring targeted instructional design (Pertinence).</p>
            <p><strong>Integration Point:</strong> Clicking the final button sends your answers to the running Flask server (`server.py`) for LLM optimization.</p>
        </div>

        <!-- Question Navigation -->
        <div class="navigation" style="text-align: center; margin-bottom: 20px;">
            <button id="prev-btn" onclick="navigateQuestion(-1)" disabled>← Previous</button>
            <span id="q-counter">Question - / -</span>
            <button id="next-btn" onclick="navigateQuestion(1)" disabled>Next →</button>
        </div>

        <!-- Question Display Area -->
        <div id="question-area">
            <h2>Question <span id="current-q-id"></span></h2>
            <p id="q-text">Loading questions...</p>
            <form id="options-form" class="question-options"></form>
            <p style="font-size: small; color: #666;">Topic: <span id="q-topic"></span></p>
        </div>

        <!-- Action Button -->
        <button id="action-btn" onclick="submitAnswer()" disabled>Save Answer & Next</button>

        <!-- Final Report Button -->
        <button id="report-btn" onclick="generateReport()" style="background-color: #007bff; display: none;">Generate LLM Optimized Lesson Plan</button>


        <!-- Feedback Area -->
        <div id="feedback-area" style="margin-top: 30px; padding: 20px; border-radius: 6px; border: 1px dashed #6c757d;">
            <h2>Quiz Status</h2>
            <p id="status-text">Waiting for questions to load.</p>
        </div>

        <!-- LLM Optimized Output Area -->
        <div id="llm-output-area" style="display: none; margin-top: 30px; padding: 20px; border-radius: 6px; border: 2px solid #28a745;">
            <h2>EduPlanner Final Output: Optimized Lesson Plan</h2>
            <p>The **Evaluator**, **Optimizer**, and **Analyst** agents' output:</p>
            <textarea id="llm-output-text" rows="20" style="width: 100%; border: 1px solid #ddd; padding: 10px;"></textarea>
            <p style="color: red;">*Ensure your Python `server.py` is running on `http://127.0.0.1:5000` before running the optimization.*</p>
        </div>
    </div>

    <script>
        let questions = [];
        let currentQuestionIndex = 0;
        let userAnswers = {}; // {Q_ID: "User's Selected Option"}
        const TARGET_TOPIC = "Process Synchronization"; // Fixed target topic for optimization

        // --- FETCH DATA ---
        // Path adjusted to look in the parent directory for os_questions.json
        fetch('/os_questions.json') 
            .then(response => response.json())
            .then(data => {
                questions = data;
                // Initialize userAnswers structure
                questions.forEach(q => userAnswers[q.id] = null);
                loadQuestion(currentQuestionIndex);
                document.getElementById('action-btn').disabled = false;
                updateFeedback();
                updateNavigationButtons();
            })
            .catch(error => {
                document.getElementById('q-text').textContent = "ERROR: Failed to load os_questions.json. Check file path.";
                console.error('Error loading questions:', error);
            });

        // --- RENDER QUESTION ---
        function loadQuestion(index) {
            if (index < 0 || index >= questions.length) return;
            
            currentQuestionIndex = index;
            const q = questions[index];
            
            document.getElementById('current-q-id').textContent = q.id;
            document.getElementById('q-counter').textContent = `Question ${index + 1} / ${questions.length}`;
            document.getElementById('q-text').textContent = q.question;
            document.getElementById('q-topic').textContent = q.topic;

            const form = document.getElementById('options-form');
            form.innerHTML = ''; // Clear previous options
            
            q.options.forEach((option, i) => {
                const radioId = `option-${q.id}-${i}`;
                const label = document.createElement('label');
                // Check the userAnswers map to see if this option was previously selected
                const checkedAttr = userAnswers[q.id] === option ? 'checked' : ''; 
                label.innerHTML = `
                    <input type="radio" name="answer-option" id="${radioId}" value="${option}" ${checkedAttr}>
                    ${option}
                `;
                form.appendChild(label);
            });

            document.getElementById('action-btn').textContent = 'Save Answer & Next';
            updateNavigationButtons();
            updateFeedback();
        }

        // --- NAVIGATION & SAVING ---
        function updateNavigationButtons() {
            const total = questions.length;
            document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
            document.getElementById('next-btn').disabled = currentQuestionIndex === total - 1;
        }

        function saveCurrentAnswer() {
            const currentQ = questions[currentQuestionIndex];
            const selectedRadio = document.querySelector('input[name="answer-option"]:checked');
            if (selectedRadio) {
                userAnswers[currentQ.id] = selectedRadio.value;
            } else if (!userAnswers[currentQ.id]) {
                 userAnswers[currentQ.id] = null; // Mark as unanswered
            }
        }

        function navigateQuestion(direction) {
            saveCurrentAnswer();
            
            if (currentQuestionIndex + direction >= 0 && currentQuestionIndex + direction < questions.length) {
                loadQuestion(currentQuestionIndex + direction);
            }
        }
        
        function submitAnswer() {
            saveCurrentAnswer();
            
            if (currentQuestionIndex < questions.length - 1) {
                navigateQuestion(1);
            } else {
                updateFeedback();
                alert("You have saved your answers for all questions! Click 'Generate LLM Optimized Lesson Plan'.");
            }
        }

        // --- GENERATE REPORT (Data Bridge and Server Call) ---
        function getQuizDataPayload() {
            let correctCount = 0;
            const quizResults = [];
            
            questions.forEach(q => {
                const userAnswer = userAnswers[q.id];
                const isCorrect = (userAnswer === q.answer);
                if (isCorrect) correctCount++;
                
                quizResults.push({
                    id: q.id,
                    topic: q.topic,
                    correct: isCorrect,
                    user_answer: userAnswer,
                    correct_answer: q.answer
                });
            });

            return {
                total_questions: questions.length,
                total_correct: correctCount,
                results: quizResults,
                final_score: Math.round((correctCount / questions.length) * 100)
            };
        }

        function updateFeedback() {
            const answeredCount = Object.values(userAnswers).filter(a => a !== null).length;
            const total = questions.length;
            
            document.getElementById('status-text').innerHTML = 
                `<strong>Progress:</strong> ${answeredCount} / ${total} questions answered.`;
            
            updateReportButton(answeredCount === total);
        }

        function updateReportButton(quizComplete) {
            if (quizComplete) {
                document.getElementById('report-btn').style.display = 'block';
                document.getElementById('action-btn').style.display = 'none';
            } else {
                document.getElementById('report-btn').style.display = 'none';
                document.getElementById('action-btn').style.display = 'block';
            }
        }

        async function generateReport() {
            const payload = getQuizDataPayload();
            
            document.getElementById('feedback-area').className = 'correct';
            document.getElementById('status-text').innerHTML = `
                Quiz Complete! **Simulated Post-Test Score: ${payload.total_correct} / ${payload.total_questions} (${payload.final_score}%)**.
                <br>
                <br>
                **LLM INTEGRATION:** Sending optimization request for topic: <strong>${TARGET_TOPIC}</strong> to server...
            `;
            
            document.getElementById('report-btn').disabled = true;
            document.getElementById('report-btn').textContent = 'Optimizing... (LLM Agents Running)';
            document.getElementById('llm-output-area').style.display = 'block';
            document.getElementById('llm-output-text').value = "Connecting to server and running multi-agent optimization. This process involves multiple high-cost LLM calls and may take 30-60 seconds...";

            try {
                // Fetch request to the Flask server endpoint
                const response = await fetch('http://127.0.0.1:5000/optimize_lesson', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        quiz_results: payload.results,
                        topic: TARGET_TOPIC,
                        simulated_score: payload.final_score 
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('llm-output-text').value = 
                        `--- EDUPLANNER BEST SCORE: ${data.score} ---\n` + 
                        `--- TARGET TOPIC: ${data.topic} ---\n` + 
                        `--- STUDENT SKILLS PROFILE ---\n` +
                        `${data.skill_tree}\n` + 
                        `\n--- OPTIMIZED LESSON PLAN ---\n` +
                        `${data.best_lesson_plan}`;
                    document.getElementById('report-btn').textContent = 'Optimization Complete';
                } else {
                    document.getElementById('llm-output-text').value = `SERVER ERROR (${response.status}): ${data.message}`;
                    document.getElementById('report-btn').textContent = 'Error During Optimization';
                }

            } catch (error) {
                document.getElementById('llm-output-text').value = `NETWORK ERROR: Could not connect to Flask server (http://127.0.0.1:5000). Check if 'python server.py' is running and the port is correct. Details: ${error}`;
                document.getElementById('report-btn').textContent = 'Connection Failed';
            } finally {
                document.getElementById('report-btn').disabled = false;
            }
        }
    </script>

</body>
</html>